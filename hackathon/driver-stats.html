<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Statistics - Traction Efficiency Analysis</title>
    <style>
/* ABOUTME: Styling for driver statistics table */
/* ABOUTME: Clean, sortable table layout with race selector */

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background-color: #0a0a0a;
    color: #ffffff;
    padding: 5vh 20px 20px 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

#content-wrapper {
    width: 80%;
    max-width: 1400px;
}

#header {
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
}

.header-left h1 {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 4px;
    letter-spacing: -0.5px;
}

.header-left p {
    font-size: 13px;
    color: #888;
    font-weight: 400;
}

#race-selector {
    display: flex;
    gap: 8px;
}

.race-btn {
    padding: 8px 16px;
    background: transparent;
    border: 1px solid #444;
    border-radius: 4px;
    color: #888;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.race-btn:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: #666;
}

.race-btn.active {
    background: rgba(212, 160, 23, 0.15);
    border-color: #d4a017;
    color: #d4a017;
}

#table-container {
    background: rgba(20, 20, 20, 0.95);
    border: 1px solid #333;
    border-radius: 6px;
    padding: 0;
    overflow-x: auto;
    max-height: calc(100vh - 110px);
    overflow-y: auto;
}

#stats-table {
    width: 100%;
    border-collapse: collapse;
}

#stats-table thead {
    background: rgba(30, 30, 30, 0.95);
    border-bottom: 1px solid #444;
}

#stats-table th {
    padding: 6px 10px;
    text-align: left;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #aaa;
    cursor: pointer;
    user-select: none;
}

#stats-table th.sortable:hover {
    background: rgba(255, 255, 255, 0.05);
    color: #d4a017;
}

#stats-table th.sorted-asc::after {
    content: ' ▲';
    color: #d4a017;
}

#stats-table th.sorted-desc::after {
    content: ' ▼';
    color: #d4a017;
}

#stats-table tbody tr {
    border-bottom: 1px solid #1a1a1a;
    transition: background 0.15s ease;
}

#stats-table tbody tr:hover {
    background: rgba(255, 255, 255, 0.05);
}

#stats-table td {
    padding: 5px 10px;
    font-size: 11px;
    color: #ccc;
}

#stats-table td:first-child {
    font-weight: 600;
    color: #ffffff;
}

#stats-table td:nth-child(n+3),
#stats-table th:nth-child(n+3) {
    text-align: center;
}

.pct-optimal {
    color: #22c55e;
    border-radius: 3px;
}

.pct-conservative {
    color: #eab308;
}

.pct-aggressive {
    color: #ef4444;
    border-radius: 3px;
}

.event-count {
    color: #888;
}
    </style>
</head>
<body>
    <div id="content-wrapper">
        <div id="header">
            <div class="header-left">
                <h1>Driver Statistics</h1>
                <p>Traction Efficiency Analysis - Barber Motorsports Park</p>
            </div>
            <div id="race-selector">
                <button class="race-btn active" data-race="R1">R1</button>
                <button class="race-btn" data-race="R2">R2</button>
                <button class="race-btn" data-race="all">Both Races</button>
            </div>
        </div>

        <div id="table-container">
            <table id="stats-table">
                <thead>
                    <tr>
                        <th data-sort="driver" class="sortable">Driver</th>
                        <th data-sort="total_time" class="sortable">Total Time</th>
                        <th data-sort="total_zones" class="sortable">Total Zones</th>
                        <th data-sort="optimal_pct" class="sortable">Optimal %</th>
                        <th data-sort="conservative_pct" class="sortable">Conservative %</th>
                        <th data-sort="aggressive_pct" class="sortable">Aggressive %</th>
                        <th data-sort="wheelspin" class="sortable">Wheelspin</th>
                        <th data-sort="understeer" class="sortable">Understeer</th>
                        <th data-sort="oversteer" class="sortable">Oversteer</th>
                        <th data-sort="avg_utilization" class="sortable">Avg Utilization %</th>
                    </tr>
                </thead>
                <tbody id="stats-body">
                    <!-- Data will be loaded dynamically -->
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
// ABOUTME: JavaScript for driver statistics table with sorting and filtering
// ABOUTME: Loads classification data and displays per-driver metrics

(async function() {
    // Load data
    const classifications = await d3.csv('data/processed/lap_classifications.csv');
    const driverTotalTimes = await d3.json('data/processed/driver_total_times.json');

    console.log(`Loaded ${classifications.length} classifications`);

    // Create set of drivers with timing data
    const driversWithTiming = new Set(Object.keys(driverTotalTimes));

    // Current state
    let currentRace = 'R1';
    let currentSort = { column: 'driver', direction: 'asc' };

    // Calculate statistics for each driver
    function calculateStats(race) {
        const filtered = race === 'all'
            ? classifications
            : classifications.filter(d => d.race === race);

        // Group by driver
        const byDriver = d3.group(filtered, d => d.vehicle_number);

        const stats = [];

        byDriver.forEach((zones, driver) => {
            // Skip drivers without timing data
            if (!driversWithTiming.has(driver)) return;
            const total = zones.length;
            const optimal = zones.filter(z => z.classification === 'Optimal').length;
            const conservative = zones.filter(z => z.classification === 'Conservative').length;
            const aggressive = zones.filter(z => z.classification === 'Aggressive').length;

            const wheelspin = zones.filter(z => z.wheelspin === 'True').length;
            const understeer = zones.filter(z => z.understeer === 'True').length;
            const oversteer = zones.filter(z => z.oversteer === 'True').length;

            const avgUtilization = d3.mean(zones, z => parseFloat(z.avg_utilization));
            // Pick total time for the selected race; for 'all', prefer R1 then R2
            const totalTimeEntry = driverTotalTimes[driver] || {};
            const bestTime = (
                currentRace === 'R1' || currentRace === 'R2'
            ) ? (totalTimeEntry[currentRace] || '--:--') : (totalTimeEntry['R1'] || totalTimeEntry['R2'] || '--:--');

            stats.push({
                driver: parseInt(driver),
                total_time: bestTime,
                total_zones: total,
                optimal_count: optimal,
                optimal_pct: Math.round(optimal / total * 100),
                conservative_count: conservative,
                conservative_pct: Math.round(conservative / total * 100),
                aggressive_count: aggressive,
                aggressive_pct: Math.round(aggressive / total * 100),
                wheelspin,
                understeer,
                oversteer,
                avg_utilization: Math.round(avgUtilization * 100)
            });
        });

        return stats;
    }

    // Sort data
    function sortData(data, column, direction) {
        return [...data].sort((a, b) => {
            let aVal = a[column];
            let bVal = b[column];

            // Convert to numbers for numeric columns
            if (column !== 'total_time') {
                aVal = parseFloat(aVal);
                bVal = parseFloat(bVal);
            }

            if (direction === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });
    }

    // Render table
    function renderTable() {
        const stats = calculateStats(currentRace);
        const sorted = sortData(stats, currentSort.column, currentSort.direction);

        // Calculate min/max for gradient
        const optimalExtent = d3.extent(sorted, d => d.optimal_pct);
        const aggressiveExtent = d3.extent(sorted, d => d.aggressive_pct);

        // Create opacity scales (min: 0.05, max: 0.35)
        const optimalOpacityScale = d3.scaleLinear()
            .domain(optimalExtent)
            .range([0.05, 0.35]);

        const aggressiveOpacityScale = d3.scaleLinear()
            .domain(aggressiveExtent)
            .range([0.05, 0.35]);

        const tbody = d3.select('#stats-body');
        tbody.selectAll('tr').remove();

        sorted.forEach(driver => {
            const row = tbody.append('tr');

            row.append('td').text(`#${driver.driver}`);
            row.append('td').text(driver.total_time);
            row.append('td').text(driver.total_zones);

            // Optimal % with green gradient (higher = better)
            const optimalOpacity = optimalOpacityScale(driver.optimal_pct);
            row.append('td')
                .attr('class', 'pct-optimal')
                .style('background-color', `rgba(34, 197, 94, ${optimalOpacity})`)
                .text(`${driver.optimal_pct}%`);

            row.append('td').attr('class', 'pct-conservative').text(`${driver.conservative_pct}%`);

            // Aggressive % with red gradient (higher = worse)
            const aggressiveOpacity = aggressiveOpacityScale(driver.aggressive_pct);
            row.append('td')
                .attr('class', 'pct-aggressive')
                .style('background-color', `rgba(239, 68, 68, ${aggressiveOpacity})`)
                .text(`${driver.aggressive_pct}%`);

            row.append('td').attr('class', 'event-count').text(driver.wheelspin);
            row.append('td').attr('class', 'event-count').text(driver.understeer);
            row.append('td').attr('class', 'event-count').text(driver.oversteer);
            row.append('td').attr('class', 'utilization').text(`${driver.avg_utilization}%`);
        });

        // Update sort indicators
        d3.selectAll('th').classed('sorted-asc', false).classed('sorted-desc', false);
        d3.select(`th[data-sort="${currentSort.column}"]`)
            .classed(`sorted-${currentSort.direction}`, true);
    }

    // Set up race selector
    d3.selectAll('.race-btn').on('click', function() {
        d3.selectAll('.race-btn').classed('active', false);
        d3.select(this).classed('active', true);

        currentRace = d3.select(this).attr('data-race');
        renderTable();
    });

    // Set up column sorting
    d3.selectAll('th.sortable').on('click', function() {
        const column = d3.select(this).attr('data-sort');

        if (currentSort.column === column) {
            // Toggle direction
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            // New column, default to desc for most metrics (except driver)
            currentSort.column = column;
            currentSort.direction = column === 'driver' || column === 'best_time' ? 'asc' : 'desc';
        }

        renderTable();
    });

    // Initial render
    renderTable();
    console.log('Driver statistics table ready');
})();
    </script>
</body>
</html>
