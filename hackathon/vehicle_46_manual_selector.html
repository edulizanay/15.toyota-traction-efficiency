<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle #46 - Manual Pit Lane Selection</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(42, 42, 42, 0.95);
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            max-width: 300px;
        }

        #info h1 {
            margin: 0 0 10px 0;
            font-size: 20px;
            color: #fbbf24;
        }

        #info .stat {
            margin: 5px 0;
        }

        #info .label {
            color: #888;
            margin-right: 8px;
        }

        #info .instruction {
            margin-top: 15px;
            padding: 10px;
            background: rgba(59, 130, 246, 0.2);
            border-left: 3px solid #3b82f6;
            border-radius: 4px;
            font-size: 13px;
        }

        #info .coords {
            margin-top: 10px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }

        #info button {
            margin-top: 10px;
            padding: 8px 16px;
            background: #10b981;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
        }

        #info button:hover {
            background: #059669;
        }

        #info button:disabled {
            background: #374151;
            cursor: not-allowed;
        }

        svg {
            display: block;
            cursor: crosshair;
        }

        .gps-trace {
            fill: none;
            stroke: #3b82f6;
            stroke-width: 1;
            stroke-linecap: round;
            stroke-linejoin: round;
            opacity: 0.6;
        }

        .gps-points {
            fill: #3b82f6;
            opacity: 0.3;
        }

        .selected-point {
            fill: #ef4444;
            stroke: #fff;
            stroke-width: 2;
        }

        .selected-segment {
            fill: none;
            stroke: #10b981;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div id="info">
        <h1>Manual Pit Lane Selector</h1>
        <div class="stat"><span class="label">Vehicle:</span>#46</div>

        <div class="instruction">
            Click on the track to select:
            <br>1. <strong>Start point</strong> of pit lane
            <br>2. <strong>End point</strong> of pit lane
        </div>

        <div class="coords">
            <div><strong>Point 1:</strong> <span id="point1">Not selected</span></div>
            <div><strong>Point 2:</strong> <span id="point2">Not selected</span></div>
            <div style="margin-top: 8px;"><strong>Points found:</strong> <span id="segment-count">0</span></div>
        </div>

        <button id="extract-btn" disabled onclick="extractPitLane()">Extract Pit Lane</button>
        <button onclick="reset()" style="background: #ef4444; margin-top: 5px;">Reset Selection</button>
    </div>

    <svg id="track-svg"></svg>

    <script>
        let vehicleData = null;
        let xScale = null;
        let yScale = null;
        let g = null;
        let selectedPoints = [];
        let nearestIndices = [];

        async function init() {
            // Load vehicle data
            vehicleData = await d3.json('data/processed/vehicle_46_gps.json');

            console.log(`Loaded vehicle #${vehicleData.vehicle_number}`);
            console.log(`Total points: ${vehicleData.total_points}`);

            // Set up SVG
            const svg = d3.select('#track-svg');
            const width = window.innerWidth;
            const height = window.innerHeight;

            svg.attr('width', width)
               .attr('height', height);

            g = svg.append('g');

            // Calculate bounds
            const xExtent = d3.extent(vehicleData.coordinates, d => d.x);
            const yExtent = d3.extent(vehicleData.coordinates, d => d.y);

            const trackWidth = xExtent[1] - xExtent[0];
            const trackHeight = yExtent[1] - yExtent[0];

            const padding = 0.05;
            const xPadding = trackWidth * padding;
            const yPadding = trackHeight * padding;

            // Create scales
            xScale = d3.scaleLinear()
                .domain([xExtent[0] - xPadding, xExtent[1] + xPadding])
                .range([0, width]);

            yScale = d3.scaleLinear()
                .domain([yExtent[0] - yPadding, yExtent[1] + yPadding])
                .range([height, 0]);

            // Create line generator
            const line = d3.line()
                .x(d => xScale(d.x))
                .y(d => yScale(d.y))
                .curve(d3.curveLinear);

            // Draw the GPS trace
            g.append('path')
                .datum(vehicleData.coordinates)
                .attr('class', 'gps-trace')
                .attr('d', line);

            // Add click handler
            svg.on('click', handleClick);

            // Add zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([0.5, 50])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);

            console.log('Ready to select points!');
        }

        function handleClick(event) {
            // Get click coordinates in data space
            const [mouseX, mouseY] = d3.pointer(event);

            // Get current transform
            const transform = d3.zoomTransform(d3.select('#track-svg').node());

            // Inverse transform to get data coordinates
            const dataX = xScale.invert((mouseX - transform.x) / transform.k);
            const dataY = yScale.invert((mouseY - transform.y) / transform.k);

            // Find nearest GPS point
            let minDist = Infinity;
            let nearestIdx = -1;

            vehicleData.coordinates.forEach((point, idx) => {
                const dx = point.x - dataX;
                const dy = point.y - dataY;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist < minDist) {
                    minDist = dist;
                    nearestIdx = idx;
                }
            });

            if (nearestIdx === -1) return;

            const nearestPoint = vehicleData.coordinates[nearestIdx];

            console.log(`Clicked: (${dataX.toFixed(1)}, ${dataY.toFixed(1)})`);
            console.log(`Nearest: (${nearestPoint.x.toFixed(1)}, ${nearestPoint.y.toFixed(1)}) at index ${nearestIdx}`);

            // Add to selected points
            if (selectedPoints.length < 2) {
                selectedPoints.push(nearestPoint);
                nearestIndices.push(nearestIdx);

                // Draw marker
                g.append('circle')
                    .attr('class', 'selected-point')
                    .attr('cx', xScale(nearestPoint.x))
                    .attr('cy', yScale(nearestPoint.y))
                    .attr('r', 8);

                // Update UI
                updateUI();

                // If we have 2 points, extract segment
                if (selectedPoints.length === 2) {
                    extractSegment();
                }
            }
        }

        function updateUI() {
            if (selectedPoints.length >= 1) {
                const p1 = selectedPoints[0];
                document.getElementById('point1').textContent =
                    `(${p1.x.toFixed(1)}, ${p1.y.toFixed(1)})`;
            }

            if (selectedPoints.length >= 2) {
                const p2 = selectedPoints[1];
                document.getElementById('point2').textContent =
                    `(${p2.x.toFixed(1)}, ${p2.y.toFixed(1)})`;
            }
        }

        function extractSegment() {
            // Get indices
            const idx1 = nearestIndices[0];
            const idx2 = nearestIndices[1];

            const startIdx = Math.min(idx1, idx2);
            const endIdx = Math.max(idx1, idx2);

            // Extract segment
            const segment = vehicleData.coordinates.slice(startIdx, endIdx + 1);

            console.log(`Extracted segment: indices ${startIdx} to ${endIdx} (${segment.length} points)`);

            // Update count
            document.getElementById('segment-count').textContent = segment.length;

            // Draw segment in green
            const line = d3.line()
                .x(d => xScale(d.x))
                .y(d => yScale(d.y))
                .curve(d3.curveLinear);

            g.append('path')
                .datum(segment)
                .attr('class', 'selected-segment')
                .attr('d', line);

            // Enable extract button
            document.getElementById('extract-btn').disabled = false;

            // Store segment for extraction
            window.selectedSegment = segment;
        }

        function extractPitLane() {
            if (!window.selectedSegment) return;

            // Create JSON data
            const pitLaneData = {
                description: "Manually selected pit lane from vehicle #46 GPS trace",
                total_distance_m: calculateDistance(window.selectedSegment),
                sample_interval_m: calculateDistance(window.selectedSegment) / window.selectedSegment.length,
                centerline: window.selectedSegment.map(p => ({
                    x_meters: p.x,
                    y_meters: p.y
                }))
            };

            // Download as JSON
            const dataStr = JSON.stringify(pitLaneData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = 'pit_lane_manual.json';
            link.click();

            console.log('Pit lane extracted!');
            console.log(pitLaneData);

            alert(`Pit lane extracted!\n${window.selectedSegment.length} points\n${pitLaneData.total_distance_m.toFixed(1)}m length\n\nSaved as: pit_lane_manual.json`);
        }

        function calculateDistance(points) {
            let total = 0;
            for (let i = 1; i < points.length; i++) {
                const dx = points[i].x - points[i-1].x;
                const dy = points[i].y - points[i-1].y;
                total += Math.sqrt(dx * dx + dy * dy);
            }
            return total;
        }

        function reset() {
            selectedPoints = [];
            nearestIndices = [];
            window.selectedSegment = null;

            // Clear markers
            g.selectAll('.selected-point').remove();
            g.selectAll('.selected-segment').remove();

            // Reset UI
            document.getElementById('point1').textContent = 'Not selected';
            document.getElementById('point2').textContent = 'Not selected';
            document.getElementById('segment-count').textContent = '0';
            document.getElementById('extract-btn').disabled = true;
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
